name: ğŸ¤– Automated Code Review

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: ğŸ” Automated Code Review
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Install dependencies
        run: npm install

      - name: âœ… Run ESLint (Code style check)
        run: npx eslint . || true

      - name: ğŸ” Run Security Scan (npm audit)
        run: npm audit --audit-level=moderate || true

      - name: ğŸ§  Run CodeQL Analysis (code quality)
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: ğŸ’¬ Post Review Summary (only for PRs)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ğŸ¤– Automated Code Review Summary
âœ… Code review checks completed successfully!

**Checks Performed:**
- Code style: ESLint
- Code quality: CodeQL
- Dependency security: npm audit`
            })

  enforce:
    name: ğŸš« Enforce Merge Policy
    runs-on: ubuntu-latest
    needs: review
    if: always()
    steps:
      - name: Fail if any job failed
        if: ${{ needs.review.result != 'success' }}
        run: |
          echo "âŒ Code review checks failed. Merge blocked."
          exit 1
