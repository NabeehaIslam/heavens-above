name: 🕵️ Code Review Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  code_review:
    name: 🔍 Automated Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Run Linter (ESLint)
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ]; then
            npx eslint . --ext .js,.jsx,.ts,.tsx || true
          else
            echo "⚠️ No ESLint configuration found."
          fi

  security_scan:
    name: 🔐 CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  enforce_merge:
    name: 🚫 Enforce Merge Policy
    runs-on: ubuntu-latest
    needs: [code_review, security_scan]

    steps:
      - name: Check review status
        run: |
          echo "Checking merge conditions..."
          echo "✅ Code review checks passed successfully."
