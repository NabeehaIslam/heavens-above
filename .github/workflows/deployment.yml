name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'

# Security: Set minimal required permissions
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ================================
  # STAGE 1: BUILD
  # ================================
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "âš ï¸ No package.json found"
          fi
      
      - name: Build application
        run: |
          if [ -f package.json ]; then
            npm run build || echo "No build script found, using static files"
          else
            echo "No package.json, deploying static files"
          fi
        env:
          CI: true
          NODE_ENV: production
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            build/
            public/
            index.html
            *.html
            *.css
            *.js
          retention-days: 1

  # ================================
  # STAGE 2: TEST
  # ================================
  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          fi
      
      - name: Run linting
        run: |
          if grep -q '"lint"' package.json 2>/dev/null; then
            npm run lint
          else
            echo "âœ“ No lint script found, skipping"
          fi
        continue-on-error: true
      
      - name: Run unit tests
        run: |
          if grep -q '"test"' package.json 2>/dev/null; then
            npm test -- --coverage --passWithNoTests
          else
            echo "âœ“ No test script found, skipping"
          fi
        env:
          CI: true
        continue-on-error: true
      
      - name: Security audit
        run: |
          if [ -f package.json ]; then
            npm audit --production --audit-level=moderate || echo "âš ï¸ Vulnerabilities found"
          fi
        continue-on-error: true
      
      - name: Dependency check
        run: |
          if [ -f package.json ]; then
            echo "ğŸ“¦ Checking for outdated packages..."
            npm outdated || true
          fi
      
      - name: HTML validation
        run: |
          echo "ğŸ” Validating HTML files..."
          find . -name "*.html" -not -path "./node_modules/*" -exec echo "Found: {}" \;
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 7
        continue-on-error: true

  # ================================
  # STAGE 3: DEPLOY
  # ================================
  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    
    # Only deploy on push to main (not on PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
        continue-on-error: true
      
      - name: Determine publish directory
        id: publish-dir
        run: |
          if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
            echo "dir=dist" >> $GITHUB_OUTPUT
            echo "ğŸ“ Using dist/ directory"
          elif [ -d "build" ] && [ "$(ls -A build)" ]; then
            echo "dir=build" >> $GITHUB_OUTPUT
            echo "ğŸ“ Using build/ directory"
          elif [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "dir=public" >> $GITHUB_OUTPUT
            echo "ğŸ“ Using public/ directory"
          elif [ -f "index.html" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
            echo "ğŸ“ Using root directory"
          else
            echo "âŒ No valid publish directory found!"
            exit 1
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.publish-dir.outputs.dir }}
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deployment success
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your site is live at: ${{ steps.deployment.outputs.page_url }}"
      
      - name: Post-deployment health check
        run: |
          echo "ğŸ¥ Waiting for site to be available..."
          sleep 10
          URL="${{ steps.deployment.outputs.page_url }}"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP $STATUS)"
          else
            echo "âš ï¸ Health check returned HTTP $STATUS (site may need time to propagate)"
          fi

  # ================================
  # NOTIFICATION (Optional)
  # ================================
  notify:
    runs-on: ubuntu-latest
    needs: [build, test, deploy]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ PIPELINE SUCCESS"
            echo "âœ… Build: ${{ needs.build.result }}"
            echo "âœ… Test: ${{ needs.test.result }}"
            echo "âœ… Deploy: ${{ needs.deploy.result }}"
          else
            echo "âŒ PIPELINE FAILED"
            echo "Build: ${{ needs.build.result }}"
            echo "Test: ${{ needs.test.result }}"
            echo "Deploy: ${{ needs.deploy.result }}"
            exit 1
          fi
